\documentclass[12pt]{article}

\usepackage[margin=1in]{geometry}  % set the margins to 1in on all sides
\usepackage{graphicx}              % to include figures
\usepackage{amsmath}               % great math stuff
\usepackage{amsfonts}              % for blackboard bold, etc
\usepackage{amsthm}                % better theorem environments
\usepackage{bm} % \bm for bold math

\usepackage{enumitem}
\usepackage{rotating} % for sideway table
\usepackage{caption} % for newline in caption
\usepackage{xcolor}
\usepackage{hyperref}
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
\usepackage{cleveref}

\usepackage{array,tabularx}
  
\usepackage{float}
\restylefloat{table}

% bibliography
\usepackage{natbib}
\bibpunct{(}{)}{;}{a}{}{,} % no comma between author and year

\title{Metropolis-Hasting for two-sided logit}
\author{Anh Le}


\begin{document}
\maketitle

\section{Notation}

Characteristics (observed data):
\begin{itemize}[noitemsep]
\item $\underset{(njobs \times nw)}{WW}$ is a matrix of job characteristics, whose $j$th row $\underset{(nw \times 1)}{WW_j}$ is job $j$'s characteristics
\item $\underset{(nworkers \times nx)}{XX}$ is a matrix of worker characteristics, whose $i$th row $\underset{(nx \times 1)}{XX_i}$ is the characteristics of worker $i$
\end{itemize}

Preferences (parameters to be estimated):
\begin{itemize}[noitemsep]
\item $\underset{(nw \times 1)}{\alpha}$: a vector of workers' preference for jobs' characteristics
\item $\underset{(nx \times njobs)}{\beta}$: a matrix of employers' preference for workers' characteristics. Each employer has his own set of preference. $\beta_j$--- $\beta$'s $j$th column---is the preference of employer $j$.
\end{itemize}

Matching structure:
\begin{itemize}
\item Worker $i$'s opportunity set is $O_i$, which includes unemployment and other jobs that are offered to worker $i$.
\end{itemize}

\section{Preliminaries}

Similar to multinomial logit (the firm is choosing between countries, similar to multinomial logit)

\begin{align}
p(A_i | O_i, \alpha_i) = \frac{\exp(\alpha'W_{a_i})}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)} \label{eq:conditional_probability_of_accept}
\end{align}

The country is deciding whether to make the offer to the firm or not, a logistic decision

\begin{align}
p(O_i | \bm{\beta}) &= \prod_{j \in O_i} p(o_{ij} = 1 | \bm{\beta}) \prod_{j \notin O_i} p(o_{ij} = 0 | \bm{\beta}) \\
&= \prod_{j \in O_i} \frac{\exp{\bm{\beta_j} ' X_i}}{1 + \exp(\bm{\beta_j}' X_i)}
 \prod_{j \notin O_i} \frac{\exp{\bm{\beta_j} ' X_i}}{1 + \exp(\bm{\beta_j}' X_i)} \label{eq:conditional_probability_of_offer}
\end{align}
\section{Update opportunity set}

Target distribution for a firm $i$ 

\begin{align}
p(O_i | A_i, \alpha, \bm{\beta}) &= \frac{p(O_i, A_i, \alpha, \bm{\beta})}{p(A_i, \alpha, \bm{\beta})}
\end{align}

We propose a new $O_i^*$ by randomly sample a new offer, $j^*$ for each firm. If the new offer is not already in the current opportunity set, we add the offer to the set. If it already is in the opportunity set, we remove it from the set.

We then calculate the Metropolis-Hasting acceptance ratio:

\begin{align}
MH_O = \frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{p(O_i^*, A_i, \alpha, \bm{\beta})}{p(A_i, \alpha, \bm{\beta})} \times \frac{p(A_i, \alpha, \bm{\beta})}{p(O_i, A_i, \alpha, \bm{\beta})} \\
&= \frac{p(O_i^*, A_i, \alpha, \bm{\beta})}{p(O_i, A_i, \alpha, \bm{\beta})} \\
&= \frac{p(A_i | O_i^*, \alpha)p(O_i^*|\bm{\beta})}{p(A_i | O_i, \alpha)p(O_i|\bm{\beta})} \label{eq:updateO_joint_dist_into_conditional_dist} \\
\end{align}

where the factorization of the likelihood in \Cref{eq:updateO_joint_dist_into_conditional_dist} is due to the fact that the acceptance of firm $i$ only depends on what is offered to it and what is its preference, $p(A_i | O_i^*, \alpha)$; what is offered to $i$ depends on the preferences of all countries, $p(O_i^* \ \bm{\beta})$.

If we plug in \Cref{eq:conditional_probability_of_accept} and \Cref{eq:conditional_probability_of_offer}

\begin{align}
\frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j) + \exp(\alpha' W_{j^*})} \times \exp(\bm{\beta}_{j^*}'X_i)
\end{align}

where $j^*$ is the index of the newly sampled job. This is the case when the newly proposed job is not already offered, so it's added to the opportunity set.

When the newly proposed job is already offered, so it's removed from the opportunity set, we have

\begin{align}
\frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j) - \exp(\alpha' W_{j^*})} \times -\exp(\bm{\beta}_{j^*}'X_i)
\end{align}

\section{Update firms' parameters, $\alpha$}

Target distribution:

\begin{align}
p(\alpha | A, O, \bm{\beta}) &= \frac{p(O, A, \alpha, \bm{\beta})}{p(A, O, \bm{\beta})}
\end{align}

We propose a new $\alpha^*$ using a symmetric proposal distribution that sample $\alpha^*$ in a box whose boundary is $\alpha^* \pm \epsilon_\alpha$

Metropolis-Hasting acceptance ratio:

\begin{align}
MH_\alpha = \frac{p(\alpha^* | A, O, \bm{\beta})}{p(\alpha | A, O, \bm{\beta})} &= \frac{p(A_i | O_i, \alpha^*)p(O_i|\bm{\beta})}{p(A_i | O_i, \alpha)p(O_i|\bm{\beta})} \\
&= \frac{p(A_i | O_i, \alpha^*)}{p(A_i | O_i, \alpha)} \label{eq:updatealpha_MHratio_final}
\end{align}

where \Cref{eq:updatealpha_MHratio_final} is due to the flat prior (so $\frac{p(\alpha^*)}{p(\alpha)}=1$) and the symmetric proposal distribution (so $\frac{p(\alpha^*|\alpha)}{p(\alpha|\alpha^*)} = 1$)

If we plug in \Cref{eq:conditional_probability_of_accept},

\begin{align}
MH_\alpha &= \prod_i \left[ \frac{\exp(\alpha^{*\prime} W_{a_i})}{\exp(\alpha' W_{a_i})} \times \frac{\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime}W_j)} \right] \\
&= \prod_i \left[ \exp(\epsilon_\alpha ' W_{a_i}) \times \frac{\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime}W_j)} \right] \\
\log MH_\alpha &= \sum_i \left[ \epsilon_\alpha' W_{a_i} + \log\left(\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)\right) - \log\left(\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime} W_j)\right) \right]
\end{align}

\section{Update countries' parameters, \texorpdfstring{$\boldmath\beta$}{}}

Target distribution:

\begin{align}
p(\bm{\beta}|A, O, \alpha) &= \frac{p(O, A, \alpha, \bm{\beta})}{p(A, O, \alpha)}
\end{align}

We propose a new $\bm{\beta}^*$ using a symmetric proposal distribution that sample $\bm{\beta}^*$ in a box with side length $\epsilon_\beta$



\end{document}
